{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="match-detail-card">
        <!-- Maç Bilgileri -->
        <div class="row g-3">
            <div class="col-12 col-md-4">
                <div class="info-card">
                    {% if is_admin %}
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Tarih</label>
                        <input type="datetime-local" class="form-control" id="match_date" 
                               value="{{ match.date.strftime('%Y-%m-%dT%H:%M') }}">
                    </div>
                    <div class="form-group mt-2">
                        <label><i class="fas fa-map-marker-alt"></i> Konum</label>
                        <input type="text" class="form-control" id="match_location" 
                               value="{{ match.location }}">
                    </div>
                    {% else %}
                    <div class="info-item">
                        <i class="fas fa-calendar"></i>
                        <span>{{ match.date.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ match.location }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="score-display text-center">
                    <h3>SKOR</h3>
                    {% if is_admin %}
                    <div class="score-input-group">
                        <input type="number" class="form-control score-input" id="score_team_a" 
                               value="{{ match.score_team_a if match.score_team_a != None }}" min="0">
                        <span class="score-divider">-</span>
                        <input type="number" class="form-control score-input" id="score_team_b" 
                               value="{{ match.score_team_b if match.score_team_b != None }}" min="0">
                        <button class="btn btn-sm btn-success ms-2" onclick="updateScore({{ match.id }})">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                    {% else %}
                    <div class="score-numbers">
                        <span class="team-score">{{ match.score_team_a if match.score_team_a != None else '-' }}</span>
                        <span class="score-divider">-</span>
                        <span class="team-score">{{ match.score_team_b if match.score_team_b != None else '-' }}</span>
                    </div>
                    {% endif %}
                    {% if match.score_team_a is not none and match.score_team_b is not none %}
                        <div class="winner-badge mt-2">
                            {% if match.score_team_a > match.score_team_b %}
                                <div class="badge bg-success">A Takımı Kazandı!</div>
                            {% elif match.score_team_b > match.score_team_a %}
                                <div class="badge bg-success">B Takımı Kazandı!</div>
                            {% else %}
                                <div class="badge bg-warning">Berabere!</div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="cost-display text-center">
                    <h4>{{ translate('total_cost') }}</h4>
                    <div class="cost-amount">{{ translate('total_amount', amount=match.total_cost) }}</div>
                    <div class="per-person-cost">
                        {{ translate('per_person_cost', amount="%.2f"|format(match.total_cost / match.match_players|length if match.match_players else 0)) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Futbol Sahası ve Takımlar -->
        <div class="football-field-container mt-4">
            <div class="football-field">
                <div class="field-divider"></div>
                <div class="goal-left"></div>
                <div class="goal-right"></div>
                <div class="center-circle"></div>
                <div class="penalty-area-left"></div>
                <div class="penalty-area-right"></div>
                
                <!-- A Takımı -->
                <div class="team-area team-a-area">
                    <div class="team-label">A TAKIMI</div>
                    {% for mp in match.match_players if mp.team == 'A' %}
                    <div class="player-card-field {{ get_player_card_class(mp.player.overall) }}">
                        <div class="player-info">
                            <span class="player-ovr badge">{{ mp.player.overall }}</span>
                            <span class="player-name">{{ mp.player.name }}</span>
                            <span class="player-position badge">{{ mp.player.position }}</span>
                        </div>
                        {% if is_admin %}
                        <div class="payment-toggle">
                            <button type="button" 
                                    class="btn btn-sm {{ 'btn-success' if mp.has_paid else 'btn-danger' }}"
                                    onclick="togglePaymentStatus({{ mp.player.id }}, {{ match.id }})">
                                <i class="fas fa-{{ 'check' if mp.has_paid else 'times' }}"></i>
                            </button>
                        </div>
                        {% else %}
                        <div class="payment-status {{ 'paid' if mp.has_paid else 'unpaid' }}">
                            <i class="fas fa-{{ 'check' if mp.has_paid else 'times' }}"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- B Takımı -->
                <div class="team-area team-b-area">
                    <div class="team-label">B TAKIMI</div>
                    {% for mp in match.match_players if mp.team == 'B' %}
                    <div class="player-card-field {{ get_player_card_class(mp.player.overall) }}">
                        <div class="player-info">
                            <span class="player-ovr badge">{{ mp.player.overall }}</span>
                            <span class="player-name">{{ mp.player.name }}</span>
                            <span class="player-position badge">{{ mp.player.position }}</span>
                        </div>
                        {% if is_admin %}
                        <div class="payment-toggle">
                            <button type="button" 
                                    class="btn btn-sm {{ 'btn-success' if mp.has_paid else 'btn-danger' }}"
                                    onclick="togglePaymentStatus({{ mp.player.id }}, {{ match.id }})">
                                <i class="fas fa-{{ 'check' if mp.has_paid else 'times' }}"></i>
                            </button>
                        </div>
                        {% else %}
                        <div class="payment-status {{ 'paid' if mp.has_paid else 'unpaid' }}">
                            <i class="fas fa-{{ 'check' if mp.has_paid else 'times' }}"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% if is_admin %}
        <div class="admin-controls mt-4 text-center">
            <button type="button" class="btn btn-danger" onclick="deleteMatch({{ match.id }})">
                <i class="fas fa-trash"></i> Maçı Sil
            </button>
        </div>
        {% endif %}
    </div>
</div>

<style>
.match-detail-card {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.info-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
}

.info-item {
    margin: 10px 0;
    font-size: 1.1em;
}

.info-item i {
    margin-right: 10px;
    color: var(--primary-color);
}

.score-display {
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-radius: 10px;
}

.score-numbers {
    font-size: 2.5em;
    font-weight: bold;
    margin: 10px 0;
}

.team-score {
    padding: 0 20px;
}

.score-divider {
    color: var(--text-color);
}

.cost-display {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
}

.cost-amount {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--primary-color);
    margin: 10px 0;
}

.payment-status {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.payment-status.paid {
    background: var(--success-color);
    color: white;
}

.payment-status.unpaid {
    background: var(--danger-color);
    color: white;
}

@media (max-width: 768px) {
    .football-field-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* iOS için daha iyi kaydırma */
        padding-bottom: 15px; /* Kaydırma çubuğu için alan */
    }
    
    .football-field {
        min-width: 600px; /* Minimum genişlik */
        height: 400px;
        margin: 0 auto;
    }
    
    .team-area {
        width: 45%;
        min-height: 350px;
        overflow-y: auto;
        padding: 10px;
    }
    
    .player-card-field {
        width: 120px;
        margin: 5px auto;
    }
    
    .score-numbers {
        font-size: 1.8em;
    }
    
    .score-input {
        width: 50px !important;
        font-size: 1.2em;
    }
    
    .info-card, .score-display, .cost-display {
        margin-bottom: 15px;
    }
    
    /* Yatay kaydırma göstergesi */
    .football-field-container::after {
        content: '← Kaydırın →';
        display: block;
        text-align: center;
        padding: 10px;
        color: rgba(255,255,255,0.6);
        font-size: 0.9em;
    }
}

/* Tablet görünümü için düzenlemeler */
@media (min-width: 769px) and (max-width: 1024px) {
    .football-field {
        height: 500px;
    }
    
    .team-area {
        width: 42%;
    }
    
    .player-card-field {
        width: 130px;
    }
}

/* Oyuncu kartları için ek stiller */
.player-card-field {
    transition: transform 0.2s ease;
    margin-bottom: 10px;
}

.player-card-field:active {
    transform: scale(0.98);
}

.player-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.player-name {
    font-weight: bold;
    text-align: center;
    word-break: break-word;
}

.payment-toggle button {
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Saha çizgileri daha belirgin */
.field-divider, .penalty-area-left, .penalty-area-right, .goal-left, .goal-right {
    border-width: 2px;
    border-color: rgba(255,255,255,0.8);
}

.score-input-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
}

.score-input {
    width: 60px !important;
    text-align: center;
    font-size: 1.5em;
    font-weight: bold;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
}

.score-input:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--primary-color);
    color: white;
}
</style>

<script>
// Skor güncelleme fonksiyonu
async function updateScore(matchId) {
    if (!requireAdmin()) return;
    
    const scoreTeamA = document.getElementById('score_team_a').value;
    const scoreTeamB = document.getElementById('score_team_b').value;
    const date = document.getElementById('match_date').value;
    const location = document.getElementById('match_location').value;
    
    try {
        const response = await fetch(`/api/matches/${matchId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                score_team_a: scoreTeamA ? parseInt(scoreTeamA) : null,
                score_team_b: scoreTeamB ? parseInt(scoreTeamB) : null,
                date: date,
                location: location
            })
        });

        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Başarılı!',
                text: 'Maç bilgileri güncellendi.',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                window.location.reload();
            });
        } else {
            throw new Error('Güncelleme başarısız');
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Maç bilgileri güncellenirken bir hata oluştu!'
        });
    }
}

// Ödeme durumu güncelleme fonksiyonu
async function togglePaymentStatus(playerId, matchId) {
    if (!requireAdmin()) return;

    try {
        const button = event.target.closest('button');
        const response = await fetch(`/api/matches/${matchId}/players/${playerId}/payment`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Buton rengini ve içeriğini güncelle
            button.classList.remove('btn-success', 'btn-danger');
            button.classList.add(data.has_paid ? 'btn-success' : 'btn-danger');
            
            const icon = button.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-check', 'fa-times');
                icon.classList.add(data.has_paid ? 'fa-check' : 'fa-times');
            }
            
            button.innerHTML = `<i class="fas fa-${data.has_paid ? 'check' : 'times'}"></i>`;
            
            // Başarı mesajı göster
            Swal.fire({
                icon: 'success',
                title: 'Başarılı!',
                text: data.message,
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            throw new Error(data.message || 'Güncelleme başarısız');
        }
    } catch (error) {
        console.error('Ödeme durumu güncelleme hatası:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Ödeme durumu güncellenirken bir hata oluştu!'
        });
    }
}
</script>
{% endblock %}